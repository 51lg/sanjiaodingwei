<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰åœ†å®šä½ - é«˜å¾·åœ°å›¾ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; }
        * { box-sizing: border-box; } /* ç¡®ä¿æ‰€æœ‰çš„å®½é«˜è®¡ç®—éƒ½åŒ…å«å†…è¾¹è·ï¼Œé˜²æ­¢æ’‘ç ´ */
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* é»˜è®¤ PC ç«¯æ§åˆ¶é¢æ¿ */
        #controls {
            position: absolute; top: 10px; left: 10px; width: 320px; max-width: calc(100vw - 20px);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000; display: flex; flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .controls-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; background: #007bff; color: white;
            border-radius: 8px 8px 0 0; cursor: pointer;
            font-weight: bold; font-size: 15px;
        }
        .controls-header.collapsed { border-radius: 8px; }

        .controls-content {
            padding: 15px; display: flex; flex-direction: column; gap: 12px;
        }

        .row { display: flex; align-items: center; gap: 8px; width: 100%; }
        #controls label { font-size: 14px; font-weight: bold; color: #333; white-space: nowrap;}
        #controls input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; }
        
        button {
            padding: 9px; border: none; border-radius: 4px; 
            font-size: 14px; font-weight: bold; color: white; cursor: pointer;
            transition: opacity 0.2s; 
            word-wrap: break-word; /* å…è®¸æ–‡å­—æ¢è¡Œ */
            white-space: normal;
        }
        button:hover { opacity: 0.8; }
        button:active { transform: scale(0.98); }
        
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; width: 100%; }
        .btn-clear { background: #dc3545; width: 100%; }
        
        .tip { 
            font-size: 12px; color: #666; background: #e9ecef; 
            padding: 8px; border-radius: 4px; line-height: 1.5;
        }

        /* PSé£æ ¼å›¾å±‚é¢æ¿ */
        .layer-panel { border: 1px solid #ddd; border-radius: 4px; display: flex; flex-direction: column; background: #fff; width: 100%; }
        .layer-header { background: #f1f3f5; padding: 6px 10px; font-size: 12px; font-weight: bold; border-bottom: 1px solid #ddd; color: #495057; }
        .layer-list { list-style: none; margin: 0; padding: 0; max-height: 140px; overflow-y: auto; width: 100%; }
        .layer-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; border-bottom: 1px solid #eee; font-size: 13px; transition: background 0.2s; }
        .layer-item:hover { background: #f8f9fa; }
        .layer-item:last-child { border-bottom: none; }
        .layer-name { flex: 1; overflow: hidden; text-overflow: ellipsis; margin-right: 5px; font-size: 12px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
        .layer-actions { display: flex; gap: 8px; flex-shrink: 0; }
        .icon-btn { cursor: pointer; border: none; background: none; font-size: 14px; padding: 0; opacity: 0.7; transition: opacity 0.2s; }
        .icon-btn:hover { opacity: 1; }

        /* ========================================================
           æ™ºèƒ½è®¾å¤‡é€‚é…ï¼šæ‰‹æœºä¸“å±â€œè¿·ä½ â€ UI (ç¼©å°çº¦ 50%ï¼Œä¸¥æ ¼é˜²æº¢å‡º)
           ======================================================== */
        body.mobile-mode #controls {
            width: 220px; /* å¤§å¹…ç¼©å°åŸºç¡€å®½åº¦ */
            max-width: 85vw; /* ä¸¥æ ¼é™åˆ¶æœ€å¤§ä¸èƒ½è¶…è¿‡å±å¹•85% */
            left: 5vw; /* å±…ä¸­åç§»ä¸€ç‚¹ */
            top: 5px;
        }
        body.mobile-mode .controls-header { padding: 6px 10px; font-size: 12px; }
        body.mobile-mode .controls-content { padding: 8px; gap: 6px; }
        body.mobile-mode .row { gap: 4px; }
        body.mobile-mode #controls label { font-size: 11px; }
        body.mobile-mode #controls input { padding: 4px; font-size: 12px; }
        body.mobile-mode button { padding: 5px; font-size: 11px; line-height: 1.2; }
        body.mobile-mode .tip { font-size: 10px; padding: 5px; line-height: 1.3; margin: 2px 0;}
        body.mobile-mode .layer-header { font-size: 11px; padding: 4px 6px; }
        body.mobile-mode .layer-item { padding: 4px 6px; }
        body.mobile-mode .layer-name { font-size: 11px; }
        body.mobile-mode .layer-list { max-height: 90px; }
        body.mobile-mode .icon-btn { font-size: 12px; }
        
        /* é’ˆå¯¹æ‰‹æœºæç«¯å°å±çš„è¿›ä¸€æ­¥ç¼©æ”¾ */
        @media (max-width: 350px) {
            body.mobile-mode #controls { width: 92vw; left: 4vw; }
            body.mobile-mode button { font-size: 10px; padding: 4px; }
        }

        /* è°ƒæ•´åœ°å›¾è‡ªå¸¦æ§ä»¶çš„ä½ç½®ï¼ˆå³ä¾§ï¼‰ï¼ŒåŒæ—¶ç¨å¾®ç¼©å°å®ƒ */
        .leaflet-top.leaflet-right {
            margin-top: 50px; 
            z-index: 999;     
        }
        body.mobile-mode .leaflet-top.leaflet-right {
            transform: scale(0.85); /* æ‰‹æœºç«¯è¿åŒåœ°å›¾æ§ä»¶ä¸€èµ·ç¼©å° */
            transform-origin: top right;
        }
    </style>
</head>
<body>

    <div id="controls">
        <div class="controls-header" onclick="togglePanel()" id="panelHeader">
            <span>âš™ï¸ æ§åˆ¶é¢æ¿</span>
            <span id="toggleIcon">â–¼</span>
        </div>
        <div class="controls-content" id="panelContent">
            
            <!-- æœç´¢æ¨¡å— -->
            <div class="row">
                <input type="text" id="searchInput" placeholder="æœåœ°ç‚¹...">
                <button class="btn-primary" onclick="searchLocation()" style="width: 50px; flex-shrink: 0;">æœç´¢</button>
            </div>

            <!-- åŠå¾„è®¾ç½® -->
            <div class="row">
                <label>åŠå¾„(KM):</label>
                <input type="number" id="radius" value="3" step="0.1" placeholder="å¦‚ 1.5">
            </div>
            
            <!-- å®šä½æŒ‰é’® -->
            <button id="locateBtn" class="btn-success" onclick="locateMe()">ğŸ“ å®šä½æˆ‘</button>

            <!-- å®šä½ç¡®è®¤åŒºåŸŸ (é»˜è®¤éšè—) -->
            <div id="locationConfirmArea" style="display: none; flex-direction: column; gap: 5px; background: #e2e3e5; padding: 6px; border-radius: 4px;">
                <div style="font-size: 11px; color: #383d41; text-align: center; font-weight: bold;">åœ¨æ­¤å¤„ç”»åœ†ï¼Ÿ</div>
                <div style="display: flex; gap: 5px;">
                    <button class="btn-success" onclick="confirmLocation()" style="flex: 1;">âœ”ï¸ ç¡®å®š</button>
                    <button class="btn-clear" onclick="cancelLocation()" style="flex: 1; background: #6c757d;">âŒ å–æ¶ˆ</button>
                </div>
            </div>

            <!-- ç‚¹å‡»ç”»åœ†å¼€å…³ -->
            <button id="clickDrawBtn" class="btn-primary" onclick="toggleClickDraw()" style="background-color: #17a2b8;">ğŸ‘† æ‰‹ç‚¹åœ°å›¾ç”»åœ†: [å¼€]</button>

            <!-- PSé£æ ¼å›¾å±‚é¢æ¿ -->
            <div class="layer-panel">
                <div class="layer-header">ğŸ“š å›¾å±‚é¢æ¿</div>
                <ul id="layerList" class="layer-list">
                    <!-- åŠ¨æ€ç”Ÿæˆå›¾å±‚ -->
                    <li style="padding: 10px; font-size: 11px; color: #999; text-align: center;">æš‚æ— å›¾å±‚</li>
                </ul>
            </div>

            <div class="tip">
                1. è¾“å…¥åŠå¾„(åƒç±³)<br>
                2. ç‚¹å‡»åœ°å›¾æˆ–æœç´¢æ¥ç”»åœ†<br>
                3. å³ä¾§å¯åˆ‡æ¢å«æ˜Ÿå›¾
            </div>

            <button class="btn-clear" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</button>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- æ™ºèƒ½è®¾å¤‡è¯†åˆ« (æ ¸å¿ƒä¼˜åŒ–) ---
        function checkDevice() {
            var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 600;
            if (isMobile) {
                document.body.classList.add('mobile-mode');
            } else {
                document.body.classList.remove('mobile-mode');
            }
        }
        // åˆå§‹åŒ–æ£€æµ‹ï¼Œå¹¶åœ¨çª—å£å¤§å°æ”¹å˜æ—¶åŠ¨æ€æ£€æµ‹
        checkDevice();
        window.addEventListener('resize', checkDevice);


        // --- åæ ‡è½¬æ¢ç®—æ³• (WGS84 -> GCJ02) ---
        const PI = 3.1415926535897932384626;
        const a = 6378245.0;
        const ee = 0.00669342162296594323;

        function transformLat(x, y) {
            let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
            ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
            ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
            return ret;
        }

        function transformLng(x, y) {
            let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
            ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
            ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
            return ret;
        }

        function wgs84togcj02(lng, lat) {
            if (lng < 72.004 || lng > 137.8347 || lat < 0.8293 || lat > 55.8271) {
                return [lng, lat]; // ä¸åœ¨å›½å†…ï¼Œä¸è¿›è¡Œè½¬æ¢
            }
            let dlat = transformLat(lng - 105.0, lat - 35.0);
            let dlng = transformLng(lng - 105.0, lat - 35.0);
            let radlat = lat / 180.0 * PI;
            let magic = Math.sin(radlat);
            magic = 1 - ee * magic * magic;
            let sqrtmagic = Math.sqrt(magic);
            dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
            dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);
            return [lng + dlng, lat + dlat];
        }

        // --- åæ ‡é€†å‘è½¬æ¢ç®—æ³• (GCJ02 -> WGS84) ç”¨äºçº æ­£æ‰‹ç‚¹åœ°å›¾çš„åç§» ---
        function gcj02towgs84(lng, lat) {
            if (lng < 72.004 || lng > 137.8347 || lat < 0.8293 || lat > 55.8271) {
                return [lng, lat];
            }
            let dlat = transformLat(lng - 105.0, lat - 35.0);
            let dlng = transformLng(lng - 105.0, lat - 35.0);
            let radlat = lat / 180.0 * PI;
            let magic = Math.sin(radlat);
            magic = 1 - ee * magic * magic;
            let sqrtmagic = Math.sqrt(magic);
            dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
            dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);
            let mglat = lat + dlat;
            let mglng = lng + dlng;
            return [lng * 2 - mglng, lat * 2 - mglat]; // è¿‘ä¼¼åç®—
        }


        // 1. åˆå§‹åŒ–åœ°å›¾
        var map = L.map('map', {
            center: [39.9042, 116.4074], // é»˜è®¤åŒ—äº¬
            zoom: 11,
            zoomControl: false // æ‰‹æœºç«¯æ¨èéšè—é»˜è®¤ç¼©æ”¾æ§ä»¶
        });

        // å›¾å±‚ç®¡ç†çŠ¶æ€ (ç±»ä¼¼PS)
        var layersData = {};
        var layerCount = 0;
        var isClickDrawEnabled = true;
        var tempLocateMarker = null; // ç”¨äºå­˜å‚¨å®šä½æ—¶çš„ä¸´æ—¶æ ‡è®°
        
        // --- æ–°å¢ï¼šæ ¸å¿ƒåæ ‡ç³»çŠ¶æ€ç®¡ç† ---
        var currentCoordSystem = 'GCJ02'; // é»˜è®¤åº•å›¾æ˜¯é«˜å¾·(GCJ02)
        var tempLocateWgsLng = null; // å­˜å‚¨å®šä½çš„ç»å¯¹æ— åç»åº¦
        var tempLocateWgsLat = null; // å­˜å‚¨å®šä½çš„ç»å¯¹æ— åçº¬åº¦

        // 2. åŠ è½½é«˜å¾·å›¾å±‚
        var gaodeVec = L.tileLayer('https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
            maxZoom: 18, attribution: 'é«˜å¾·åœ°å›¾'
        });
        var gaodeSat = L.tileLayer('https://webst01.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}', {
            maxZoom: 18, attribution: 'é«˜å¾·å«æ˜Ÿ'
        });
        
        // è°·æ­Œå«æ˜Ÿæ··åˆå›¾å±‚ (lyrs=y è¡¨ç¤ºå«æ˜Ÿå›¾+åœ°å/é“è·¯æ ‡ç­¾)
        var googleSat = L.tileLayer('https://mt{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            maxZoom: 18,
            subdomains: ['0', '1', '2', '3'],
            attribution: 'Â© Google Maps'
        });

        gaodeVec.addTo(map);

        var baseMaps = {
            "é«˜å¾·æ ‡å‡†å›¾": gaodeVec,
            "é«˜å¾·å«æ˜Ÿå›¾": gaodeSat,
            "è°·æ­Œå«æ˜Ÿå›¾": googleSat
        };
        
        L.control.layers(baseMaps, null, {position: 'topright'}).addTo(map);

        // --- æ ¸å¿ƒä¼˜åŒ–ï¼šç›‘å¬å›¾å±‚åˆ‡æ¢ï¼ŒåŠ¨æ€ä¿®æ­£åæ ‡åç§» ---
        map.on('baselayerchange', function (e) {
            var newCoordSystem = (e.name === 'è°·æ­Œå«æ˜Ÿå›¾') ? 'WGS84' : 'GCJ02';
            
            if (newCoordSystem !== currentCoordSystem) {
                // 1. ä¿®æ­£åœ°å›¾ä¸­å¿ƒç‚¹è§†è§’ï¼Œè®©ç”»é¢ä¿æŒåœ¨åŒä¸€å»ºç­‘ç‰©ä¸Š
                var center = map.getCenter();
                var newCenter;
                if (newCoordSystem === 'WGS84') { // æ¢æˆè°·æ­Œï¼šæŠ¹é™¤åç§»
                    var wgs = gcj02towgs84(center.lng, center.lat);
                    newCenter = L.latLng(wgs[1], wgs[0]);
                } else { // æ¢å›é«˜å¾·ï¼šåŠ ä¸Šåç§»
                    var gcj = wgs84togcj02(center.lng, center.lat);
                    newCenter = L.latLng(gcj[1], gcj[0]);
                }
                map.setView(newCenter, map.getZoom(), { animate: false });
                
                currentCoordSystem = newCoordSystem; // æ›´æ–°å½“å‰ç³»ç»ŸçŠ¶æ€
                
                // 2. ä¿®æ­£ä¸´æ—¶å®šä½å›¾æ ‡ (å¦‚æœæ­¤æ—¶æ­£åœ¨è¯¢é—®"æ˜¯å¦åœ¨æ­¤ç”»åœ†")
                if (tempLocateMarker && tempLocateWgsLng) {
                    var tLatLng;
                    if (currentCoordSystem === 'GCJ02') {
                        var tGcj = wgs84togcj02(tempLocateWgsLng, tempLocateWgsLat);
                        tLatLng = L.latLng(tGcj[1], tGcj[0]);
                    } else {
                        tLatLng = L.latLng(tempLocateWgsLat, tempLocateWgsLng);
                    }
                    tempLocateMarker.setLatLng(tLatLng);
                }
                
                // 3. ä¿®æ­£æ‰€æœ‰å·²ç»ç”»å¥½çš„åœ†åœˆä½ç½®
                Object.keys(layersData).forEach(function(id) {
                    var data = layersData[id];
                    var renderLatlng;
                    if (currentCoordSystem === 'GCJ02') {
                        var gcjCoords = wgs84togcj02(data.wgsLng, data.wgsLat);
                        renderLatlng = L.latLng(gcjCoords[1], gcjCoords[0]);
                    } else {
                        renderLatlng = L.latLng(data.wgsLat, data.wgsLng);
                    }
                    // æ‰¹é‡æ›´æ–°æ¯ä¸ªåœ†å’Œä¸­å¿ƒç‚¹çš„ä½ç½®ï¼Œä¸é—ªçƒ
                    data.group.eachLayer(function(layer) {
                        layer.setLatLng(renderLatlng);
                    });
                });
            }
        });


        // --- å›¾å±‚é¢æ¿ UI æ›´æ–°é€»è¾‘ ---
        function updateLayerUI() {
            var list = document.getElementById('layerList');
            list.innerHTML = '';
            var keys = Object.keys(layersData).reverse(); // æ–°å›¾å±‚åœ¨æœ€ä¸Šé¢
            
            if (keys.length === 0) {
                list.innerHTML = '<li style="padding: 10px; font-size: 11px; color: #999; text-align: center;">æš‚æ— å›¾å±‚</li>';
                return;
            }

            keys.forEach(function(id) {
                var data = layersData[id];
                var li = document.createElement('li');
                li.className = 'layer-item';
                
                var nameSpan = document.createElement('span');
                nameSpan.className = 'layer-name';
                nameSpan.innerText = data.name;
                nameSpan.title = data.name; // é•¿æŒ‰æˆ–é¼ æ ‡æ‚¬æµ®å¯çœ‹å…¨å
                if(!data.visible) {
                    nameSpan.style.color = '#adb5bd';
                    nameSpan.style.textDecoration = 'line-through';
                }
                
                var actions = document.createElement('div');
                actions.className = 'layer-actions';
                
                var eyeBtn = document.createElement('button');
                eyeBtn.className = 'icon-btn';
                eyeBtn.innerHTML = data.visible ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
                eyeBtn.title = "æ˜¾ç¤º/éšè—å›¾å±‚";
                eyeBtn.onclick = function() { toggleLayerVisibility(id); };
                
                var delBtn = document.createElement('button');
                delBtn.className = 'icon-btn';
                delBtn.innerHTML = 'ğŸ—‘ï¸';
                delBtn.title = "åˆ é™¤æ­¤å›¾å±‚";
                delBtn.onclick = function() { deleteLayer(id); };
                
                actions.appendChild(eyeBtn);
                actions.appendChild(delBtn);
                li.appendChild(nameSpan);
                li.appendChild(actions);
                list.appendChild(li);
            });
        }

        function toggleLayerVisibility(id) {
            var data = layersData[id];
            if(data.visible) {
                map.removeLayer(data.group);
                data.visible = false;
            } else {
                map.addLayer(data.group);
                data.visible = true;
            }
            updateLayerUI();
        }

        function deleteLayer(id) {
            var data = layersData[id];
            map.removeLayer(data.group);
            delete layersData[id];
            updateLayerUI();
        }

        // --- æ ¸å¿ƒç”»åœ†é€»è¾‘ (ç»Ÿä¸€æ”¹ä¸ºæ¥æ”¶çœŸå®çš„ WGS84 ç»å¯¹åæ ‡) ---
        function createCircleLayer(wgsLng, wgsLat, sourceName) {
            var r = parseFloat(document.getElementById('radius').value);
            if(isNaN(r) || r <= 0) {
                r = 3; // é»˜è®¤3å…¬é‡Œ
                document.getElementById('radius').value = 3;
            }
            
            var radiusInMeters = r * 1000; // åƒç±³è½¬ç±³

            // æ ¹æ®å½“å‰æ­£åœ¨çœ‹å“ªç§åº•å›¾ï¼Œæ¥å†³å®šâ€œæ˜¾ç¤ºåœ¨å“ªé‡Œâ€
            var renderLatlng;
            if (currentCoordSystem === 'GCJ02') {
                var gcj = wgs84togcj02(wgsLng, wgsLat);
                renderLatlng = L.latLng(gcj[1], gcj[0]);
            } else {
                renderLatlng = L.latLng(wgsLat, wgsLng);
            }

            // æ·»åŠ ä¸­å¿ƒç‚¹å’Œåœ†
            var marker = L.circleMarker(renderLatlng, {
                radius: 4, color: '#000', fillColor: '#fff', fillOpacity: 1
            });
            var circle = L.circle(renderLatlng, {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.25,
                radius: radiusInMeters
            });

            // ç»„åˆæˆä¸€ä¸ªå›¾å±‚ç»„
            var layerGroup = L.layerGroup([marker, circle]).addTo(map);

            // æ³¨å†Œåˆ°å›¾å±‚é¢æ¿ï¼Œå¹¶å°†çœŸå®çš„ wgs åæ ‡å¦¥å–„ä¿å­˜èµ·æ¥ï¼
            layerCount++;
            var layerId = 'layer_' + Date.now();
            var finalName = sourceName ? sourceName : "æœªçŸ¥ä½ç½®";
            layersData[layerId] = {
                group: layerGroup,
                visible: true,
                name: `L${layerCount}: ${finalName} (${r}KM)`,
                wgsLng: wgsLng,
                wgsLat: wgsLat
            };

            updateLayerUI();
        }

        // 3. æ‰‹ç‚¹åœ°å›¾ç”»åœ†å¼€å…³
        function toggleClickDraw() {
            isClickDrawEnabled = !isClickDrawEnabled;
            var btn = document.getElementById('clickDrawBtn');
            if (isClickDrawEnabled) {
                btn.style.backgroundColor = '#17a2b8';
                btn.innerText = 'ğŸ‘† æ‰‹ç‚¹åœ°å›¾ç”»åœ†: [å¼€]';
            } else {
                btn.style.backgroundColor = '#6c757d';
                btn.innerText = 'ğŸ‘† æ‰‹ç‚¹åœ°å›¾ç”»åœ†: [å…³]';
            }
        }

        map.on('click', function(e) {
            if (isClickDrawEnabled) {
                // å¦‚æœåœ¨æœ‰åç§»çš„é«˜å¾·åœ°å›¾ä¸Šç‚¹å‡»ï¼Œéœ€â€œé€†å‘â€ç®—å‡ºçœŸå® WGS åæ ‡ä¿å­˜
                var wgsLng, wgsLat;
                if (currentCoordSystem === 'GCJ02') {
                    var wgs = gcj02towgs84(e.latlng.lng, e.latlng.lat);
                    wgsLng = wgs[0];
                    wgsLat = wgs[1];
                } else {
                    wgsLng = e.latlng.lng;
                    wgsLat = e.latlng.lat;
                }
                createCircleLayer(wgsLng, wgsLat, "æ‰‹ç‚¹åœ°å›¾");
            }
        });


        // --- é¢æ¿æœ€å°åŒ–åŠŸèƒ½ ---
        var isPanelOpen = true;
        function togglePanel() {
            var content = document.getElementById('panelContent');
            var header = document.getElementById('panelHeader');
            var icon = document.getElementById('toggleIcon');
            
            isPanelOpen = !isPanelOpen;
            if (isPanelOpen) {
                content.style.display = 'flex';
                icon.innerText = 'â–¼';
                header.classList.remove('collapsed');
            } else {
                content.style.display = 'none';
                icon.innerText = 'â—€';
                header.classList.add('collapsed');
            }
        }


        // --- å®šä½åŠŸèƒ½ ---
        function locateMe() {
            if ("geolocation" in navigator) {
                const btn = document.getElementById('locateBtn');
                const originalText = btn.innerText;
                btn.innerText = "ğŸ“ æ­£åœ¨å®šä½...";
                
                navigator.geolocation.getCurrentPosition(function(position) {
                    btn.innerText = originalText;
                    var wgsLng = position.coords.longitude;
                    var wgsLat = position.coords.latitude;
                    
                    // æ ¹æ®å½“å‰åº•å›¾å†³å®šä¸´æ—¶æ°´æ»´æ»´åœ¨å“ªé‡Œ
                    var renderLatlng;
                    if (currentCoordSystem === 'GCJ02') {
                        var gcjCoords = wgs84togcj02(wgsLng, wgsLat);
                        renderLatlng = L.latLng(gcjCoords[1], gcjCoords[0]);
                    } else {
                        renderLatlng = L.latLng(wgsLat, wgsLng);
                    }
                    
                    map.setView(renderLatlng, 18);
                    
                    if(tempLocateMarker) { map.removeLayer(tempLocateMarker); }
                    tempLocateMarker = L.marker(renderLatlng).addTo(map);
                    
                    // è®°å½•æ­¤æ—¶çš„çœŸå®åæ ‡å¤‡ç”¨
                    tempLocateWgsLng = wgsLng;
                    tempLocateWgsLat = wgsLat;

                    btn.style.display = 'none';
                    document.getElementById('locationConfirmArea').style.display = 'flex';
                    
                    if(!isPanelOpen) {
                        togglePanel();
                    }
                }, function(error) {
                    btn.innerText = originalText;
                    alert("å®šä½å¤±è´¥ï¼Œè¯·ç¡®ä¿å·²æˆäºˆæµè§ˆå™¨ä½ç½®æƒé™ã€‚");
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            } else {
                alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½ã€‚");
            }
        }

        // --- ç¡®è®¤å®šä½å¹¶ç”»åœ† ---
        function confirmLocation() {
            if(tempLocateWgsLng && tempLocateWgsLat) {
                createCircleLayer(tempLocateWgsLng, tempLocateWgsLat, "æˆ‘çš„ä½ç½®");
            }
            resetLocateUI();
            map.setZoom(13); 
        }

        // --- å–æ¶ˆå®šä½ç”»åœ† ---
        function cancelLocation() {
            resetLocateUI();
        }

        function resetLocateUI() {
            if(tempLocateMarker) {
                map.removeLayer(tempLocateMarker);
                tempLocateMarker = null;
            }
            tempLocateWgsLng = null;
            tempLocateWgsLat = null;
            document.getElementById('locateBtn').style.display = 'block';
            document.getElementById('locationConfirmArea').style.display = 'none';
        }


        // --- æœç´¢åŠŸèƒ½ ---
        function searchLocation() {
            var kw = document.getElementById('searchInput').value.trim();
            if(!kw) {
                alert("è¯·è¾“å…¥æœç´¢å†…å®¹");
                return;
            }
            
            var url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(kw)}&limit=1`;
            
            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerText;
            btn.innerText = "ä¸­...";

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    btn.innerText = originalText;
                    if(data && data.length > 0) {
                        var wgsLat = parseFloat(data[0].lat);
                        var wgsLng = parseFloat(data[0].lon);
                        
                        // æ ¹æ®å½“å‰åº•å›¾å†³å®šç”»é¢é£å‘å“ªé‡Œ
                        var renderLatlng;
                        if (currentCoordSystem === 'GCJ02') {
                            var gcjCoords = wgs84togcj02(wgsLng, wgsLat);
                            renderLatlng = L.latLng(gcjCoords[1], gcjCoords[0]);
                        } else {
                            renderLatlng = L.latLng(wgsLat, wgsLng);
                        }
                        
                        map.setView(renderLatlng, 13);
                        createCircleLayer(wgsLng, wgsLat, kw);
                        
                        if(document.body.classList.contains('mobile-mode') && isPanelOpen) {
                            togglePanel();
                        }
                    } else {
                        alert("æœªæ‰¾åˆ°è¯¥åœ°ç‚¹ï¼Œè¯·å°è¯•è¾“å…¥æ›´è¯¦ç»†çš„åœ°å€ã€‚");
                    }
                })
                .catch(err => {
                    btn.innerText = originalText;
                    alert("æœç´¢è¯·æ±‚å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
                });
        }

        // --- æ¸…ç©ºåŠŸèƒ½ ---
        function clearAll() {
            Object.keys(layersData).forEach(function(id) {
                map.removeLayer(layersData[id].group);
            });
            layersData = {};
            layerCount = 0;
            updateLayerUI();
        }

    </script>
</body>
</html>
