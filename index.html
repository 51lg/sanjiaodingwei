<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“¦ å­˜è¯å®éªŒå®¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        body { background-color: #000; color: white; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }
        .hidden { display: none !important; }
        
        #scanner-container { 
            width: 100%; height: 50vh; background: #000; border-radius: 12px; overflow: hidden; border: 2px solid #333; 
            position: relative;
        }
        #scanner-container video { object-fit: cover !important; width: 100% !important; height: 100% !important; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .recording-border { box-shadow: inset 0 0 0 6px red; animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        /* æ‰«æåŒºåŸŸæŒ‡ç¤ºæ¡† */
        .scan-region {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; height: 150px;
            border: 2px dashed rgba(0, 255, 0, 0.5);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); /* é®ç½©æ•ˆæœ */
            pointer-events: none; z-index: 10;
        }
        .scan-line {
            position: absolute; width: 100%; height: 2px; background: #ef4444; top: 0;
            animation: scan 1.5s cubic-bezier(0.4, 0, 0.2, 1) infinite; z-index: 20;
        }
        @keyframes scan { 0% { top: 0; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        
        /* å®éªŒå®¤é¢æ¿ */
        .lab-panel {
            background: #111; border: 1px solid #333; padding: 10px; border-radius: 8px; margin-bottom: 10px;
        }
        .lab-btn {
            background: #222; border: 1px solid #444; color: #ccc; padding: 5px 10px; border-radius: 4px; font-size: 12px;
        }
        .lab-btn.active { background: #2563eb; color: white; border-color: #3b82f6; }
    </style>
</head>
<body class="p-4 flex flex-col h-screen pb-safe">

    <!-- é¡¶éƒ¨ -->
    <div class="flex justify-between items-center mb-2">
        <h1 class="text-lg font-bold text-white flex items-center gap-2">
            ğŸ§¬ å­˜è¯å®éªŒå®¤
            <span class="text-[10px] bg-purple-600 px-1 rounded font-mono" id="sys-badge">TEST MODE</span>
        </h1>
        <div class="flex gap-2">
             <button onclick="toggleLog()" class="text-xs bg-gray-800 px-2 py-1 rounded border border-gray-600">ğŸ“ æ—¥å¿—</button>
             <button onclick="toggleTorch()" id="torch-btn" class="bg-gray-800 p-2 rounded-full border border-gray-600 active:bg-yellow-600 disabled:opacity-50 transition-colors">ğŸ”¦</button>
        </div>
    </div>

    <!-- å®éªŒå®¤æ§åˆ¶é¢æ¿ (iOS æ•‘æ˜Ÿ) -->
    <div class="lab-panel">
        <div class="flex justify-between items-center mb-2">
            <span class="text-xs font-bold text-yellow-400">ğŸ› ï¸ iOS è°ƒè¯•é…ç½®</span>
            <select id="camera-select" class="bg-gray-800 text-xs border border-gray-600 rounded px-1 py-1 w-32" onchange="restartWithConfig()">
                <option value="">è‡ªåŠ¨é€‰æ‹©æ‘„åƒå¤´</option>
            </select>
        </div>
        <div class="grid grid-cols-3 gap-2 mb-2">
            <button onclick="setRes('720')" id="btn-720" class="lab-btn active">720P (ç¨³)</button>
            <button onclick="setRes('1080')" id="btn-1080" class="lab-btn">1080P (æ¸…)</button>
            <button onclick="setRes('4k')" id="btn-4k" class="lab-btn">4K (æ)</button>
        </div>
        <div class="grid grid-cols-2 gap-2">
            <button onclick="setFormat('1d')" id="btn-1d" class="lab-btn active">ä»…æ¡å½¢ç  (å¿«)</button>
            <button onclick="setFormat('all')" id="btn-all" class="lab-btn">å…¨æ ¼å¼ (å…¨)</button>
        </div>
        <div class="mt-2 text-[10px] text-gray-500 text-center" id="config-desc">å½“å‰: 720P / ä»…æ¡å½¢ç  (æ¨èiOS)</div>
    </div>

    <!-- è°ƒè¯•æ—¥å¿—çª—å£ -->
    <div id="debug-log" class="hidden fixed inset-0 bg-black/95 z-[100] p-4 font-mono text-xs overflow-y-auto text-green-400">
        <div class="flex justify-between items-center border-b border-gray-700 pb-2 mb-2 sticky top-0 bg-black">
            <span class="font-bold text-white">è¿è¡Œæ—¥å¿—</span>
            <button onclick="toggleLog()" class="text-red-500 border border-red-900 px-2 rounded">å…³é—­</button>
        </div>
        <div id="log-content"></div>
    </div>

    <!-- æ‰«æåŒº -->
    <div id="scanner-wrapper" class="relative shadow-2xl rounded-xl overflow-hidden bg-gray-900">
        <div id="scanner-container">
            <!-- è§†è§‰è¾…åŠ©æ¡† -->
            <div class="scan-region">
                <div class="scan-line hidden" id="scan-line-el"></div>
            </div>
        </div>
        
        <div class="absolute top-4 left-4 bg-black/60 backdrop-blur px-3 py-1 rounded border border-white/20 z-10">
            <p class="text-[10px] text-gray-400 uppercase">å½“å‰å•å·</p>
            <p class="text-xl font-mono text-green-400 font-bold tracking-wider" id="current-barcode">READY</p>
        </div>
        <div class="absolute top-4 right-4 bg-red-600 text-white px-2 py-1 rounded text-xs font-bold hidden z-10 animate-pulse" id="rec-badge">â— REC</div>
        <div id="toast" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-full text-center pointer-events-none opacity-0 transition-opacity duration-200 z-50 px-4">
            <span class="bg-black/90 text-white px-6 py-4 rounded-xl text-xl font-bold shadow-2xl border border-gray-500 backdrop-blur-md block" id="toast-text"></span>
        </div>
    </div>

    <!-- å˜ç„¦ -->
    <div class="mt-4 mb-2 bg-gray-900 p-3 rounded-lg border border-gray-800 flex items-center gap-3">
        <span class="text-xs text-gray-400">1x</span>
        <input type="range" id="zoom-slider" min="1" max="5" step="0.1" value="1" disabled oninput="applyZoom(this.value)">
        <span class="text-xs text-gray-400">5x</span>
    </div>

    <!-- åº•éƒ¨æŒ‰é’® -->
    <div class="flex-1 flex flex-col justify-end gap-3">
        <button onclick="startPipeline()" id="main-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold text-xl shadow-lg transition-all border border-blue-400/30 active:scale-95">
            ğŸ“¸ å¯åŠ¨æ‰«æ
        </button>
        <div class="flex justify-between items-center px-1">
            <div class="flex gap-4">
                <a href="#" onclick="showHistory()" class="text-sm text-gray-400 hover:text-white">ğŸ“‚ å†å²</a>
                <a href="#" onclick="manualTriggerDialog()" class="text-sm text-gray-400 hover:text-white">âŒ¨ï¸ è¾“å•</a>
            </div>
            <span id="storage-info" class="text-[10px] text-gray-600 font-mono">å­˜å‚¨: --</span>
        </div>
    </div>

    <!-- å†å²è®°å½• -->
    <div id="history-modal" class="fixed inset-0 bg-black/95 z-50 hidden flex flex-col p-4 animate-fade-in">
        <div class="flex justify-between items-center mb-4 border-b border-gray-800 pb-2">
            <h2 class="text-xl font-bold text-white">ğŸ“œ å†å²è®°å½•</h2>
            <button onclick="closeHistory()" class="text-3xl text-gray-400 hover:text-white">&times;</button>
        </div>
        <input id="search-input" class="bg-gray-800 p-3 rounded-lg text-white border border-gray-700 w-full mb-4 outline-none" placeholder="ğŸ” æœç´¢..." oninput="doSearch()">
        <div id="video-list" class="flex-1 overflow-y-auto space-y-2 pb-4"></div>
        <div class="mt-2 pt-2 border-t border-gray-800 flex gap-2">
             <button onclick="clearOldData()" class="flex-1 bg-yellow-900/30 text-yellow-500 text-xs py-3 rounded-lg">ğŸ§¹ æ¸…ç†30å¤©å‰</button>
             <button onclick="clearAllData()" class="flex-1 bg-red-900/30 text-red-500 text-xs py-3 rounded-lg">ğŸ—‘ï¸ å¼ºåˆ¶æ¸…ç©º</button>
        </div>
    </div>
    <div id="player-modal" class="fixed inset-0 bg-black z-[60] hidden flex flex-col justify-center bg-opacity-95">
        <button onclick="closePlayer()" class="absolute top-6 right-6 text-white text-3xl z-20 bg-gray-800 rounded-full w-12 h-12 flex items-center justify-center">&times;</button>
        <video id="main-player" controls playsinline class="w-full max-h-[80vh] bg-black"></video>
        <div class="text-center mt-6"><h3 id="player-title" class="text-xl font-mono text-white mb-4"></h3><a id="download-btn" href="#" download class="bg-blue-600 text-white px-8 py-3 rounded-full font-bold">ğŸ’¾ ä¿å­˜</a></div>
    </div>

    <script>
        // --- æ—¥å¿—ä¸é…ç½® ---
        function log(msg) {
            const el = document.getElementById('log-content');
            const d = new Date();
            el.innerHTML += `<div>[${d.getSeconds()}:${d.getMilliseconds()}] ${msg}</div>`;
            console.log(msg);
        }
        function toggleLog() { document.getElementById('debug-log').classList.toggle('hidden'); }

        const DB_NAME = 'PipelineDB';
        const DUPLICATE_INTERVAL_MS = 1500; 
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

        // é»˜è®¤é…ç½®
        let currentRes = '720';
        let currentFormatMode = '1d';
        
        let db, html5QrCode, mediaRecorder;
        let recordedChunks = [], isRunning = false, isRecording = false;
        let currentCode = null, lastCodeTime = 0;
        let stream = null, videoTrack = null, trackCapabilities = {};

        // æ ¼å¼å®šä¹‰
        const FORMATS_1D = [
            Html5QrcodeSupportedFormats.CODE_128, Html5QrcodeSupportedFormats.EAN_13,
            Html5QrcodeSupportedFormats.EAN_8, Html5QrcodeSupportedFormats.CODE_39,
            Html5QrcodeSupportedFormats.UPC_A, Html5QrcodeSupportedFormats.ITF
        ];
        // å…¨æ ¼å¼ (åŒ…æ‹¬äºŒç»´ç )
        const FORMATS_ALL = undefined; // undefined æ„å‘³ç€åº“é»˜è®¤æ”¯æŒæ‰€æœ‰

        // å®éªŒå®¤é…ç½®åˆ‡æ¢
        function setRes(res) {
            currentRes = res;
            document.querySelectorAll('[id^="btn-"]').forEach(b => { if(b.id.includes(res)) b.classList.add('active'); else if(!b.id.includes('btn-1d') && !b.id.includes('btn-all')) b.classList.remove('active'); });
            restartWithConfig();
        }
        function setFormat(fmt) {
            currentFormatMode = fmt;
            document.getElementById('btn-1d').classList.toggle('active', fmt==='1d');
            document.getElementById('btn-all').classList.toggle('active', fmt==='all');
            restartWithConfig();
        }
        function restartWithConfig() {
            if(isRunning) {
                stopPipeline().then(() => setTimeout(startPipeline, 500));
            }
            updateConfigDesc();
        }
        function updateConfigDesc() {
            const resMap = {'720': '720P (ç¨³)', '1080': '1080P', '4k': '4K'};
            const fmtMap = {'1d': 'ä»…æ¡å½¢ç ', 'all': 'å…¨æ ¼å¼'};
            document.getElementById('config-desc').innerText = `é…ç½®: ${resMap[currentRes]} / ${fmtMap[currentFormatMode]}`;
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function beep(f=1200,d=80){if(audioCtx.state==='suspended')audioCtx.resume();const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='square';o.frequency.value=f;o.connect(g);g.connect(audioCtx.destination);o.start();setTimeout(()=>o.stop(),d);}
        function errorBeep(){const n=audioCtx.currentTime,o=audioCtx.createOscillator(),g=audioCtx.createGain();o.type='sawtooth';o.frequency.value=150;o.connect(g);g.connect(audioCtx.destination);o.start(n);o.stop(n+0.4);}

        const initDB=()=>{const r=indexedDB.open(DB_NAME,1);r.onupgradeneeded=e=>{db=e.target.result;if(!db.objectStoreNames.contains('videos')){db.createObjectStore('videos',{keyPath:'id',autoIncrement:true}).createIndex('barcode','barcode');}};r.onsuccess=e=>{db=e.target.result;updateStorageInfo();};};
        const checkDuplicate=(c)=>new Promise(r=>{if(!db)return r(!1);db.transaction(['videos'],'readonly').objectStore('videos').index('barcode').getKey(c).onsuccess=e=>r(!!e.target.result);});
        const saveVideo=(b,blob)=>{if(!b||!blob||blob.size===0)return;db.transaction(['videos'],'readwrite').objectStore('videos').add({barcode:b,blob:blob,created:Date.now(),size:blob.size}).onsuccess=()=>{showToast(`âœ… ${b} å·²å½’æ¡£`);updateStorageInfo();};};

        // --- è·å–æ‘„åƒå¤´åˆ—è¡¨ ---
        function getCameras() {
            Html5Qrcode.getCameras().then(devices => {
                const sel = document.getElementById('camera-select');
                sel.innerHTML = '<option value="">è‡ªåŠ¨é€‰æ‹©</option>';
                if (devices && devices.length) {
                    devices.forEach((d, idx) => {
                        const opt = document.createElement('option');
                        opt.value = d.id;
                        opt.text = d.label || `æ‘„åƒå¤´ ${idx+1}`;
                        sel.appendChild(opt);
                    });
                    log(`å‘ç° ${devices.length} ä¸ªæ‘„åƒå¤´`);
                }
            }).catch(err => log("è·å–æ‘„åƒå¤´å¤±è´¥: " + err));
        }

        async function startPipeline() {
            if (isRunning) { stopPipeline(); return; }

            try {
                if (!html5QrCode) html5QrCode = new Html5Qrcode("scanner-container");

                // 1. æ„å»ºåˆ†è¾¨ç‡çº¦æŸ
                let widthIdeal, heightIdeal;
                if (currentRes === '720') { widthIdeal = 1280; heightIdeal = 720; }
                else if (currentRes === '1080') { widthIdeal = 1920; heightIdeal = 1080; }
                else { widthIdeal = 3840; heightIdeal = 2160; } // 4K

                const selectedCamId = document.getElementById('camera-select').value;
                
                const constraints = { 
                    focusMode: "continuous", 
                    width: { ideal: widthIdeal }, 
                    height: { ideal: heightIdeal } 
                };
                if (selectedCamId) {
                    constraints.deviceId = { exact: selectedCamId };
                } else {
                    constraints.facingMode = "environment";
                }

                // 2. æ„å»ºæ ¼å¼é…ç½®
                const formats = currentFormatMode === '1d' ? FORMATS_1D : FORMATS_ALL;
                
                // 3. æ„å»ºæ ¸å¿ƒé…ç½®
                // iOS æ ¸å¿ƒè¦ç‚¹ï¼šåˆ†è¾¨ç‡ä¸èƒ½å¤ªé«˜ï¼ŒuseBarCodeDetectorIfSupported å¿…é¡»å…³æ‰ï¼ˆå¦‚æœå¡é¡¿çš„è¯ï¼‰
                // æˆ‘ä»¬è¿™é‡Œè®© Android å¼€å¯ç¡¬ä»¶åŠ é€Ÿï¼ŒiOS å…³é—­
                const useNative = !isIOS; 

                const config = { 
                    fps: 30, 
                    qrbox: { width: 300, height: 150 }, 
                    aspectRatio: 1.0, 
                    formatsToSupport: formats, 
                    useBarCodeDetectorIfSupported: useNative,
                    videoConstraints: constraints 
                };

                log(`å¯åŠ¨é…ç½®: Res=${currentRes}, Fmt=${currentFormatMode}, Native=${useNative}`);

                await html5QrCode.start(
                    selectedCamId ? { deviceId: { exact: selectedCamId } } : constraints, 
                    config, 
                    handleBarcode, 
                    () => {}
                );

                const videoElement = document.querySelector("#scanner-container video");
                stream = videoElement.srcObject;
                videoTrack = stream.getVideoTracks()[0];
                const settings = videoTrack.getSettings();
                log(`å®é™…åˆ†è¾¨ç‡: ${settings.width}x${settings.height}`);
                
                trackCapabilities = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};

                const slider = document.getElementById('zoom-slider');
                if (trackCapabilities.zoom) {
                    slider.min = trackCapabilities.zoom.min; slider.max = trackCapabilities.zoom.max; slider.step = 0.1;
                    // iOS å¦‚æœåˆ‡äº† 720Pï¼Œå˜ç„¦ç¨å¾®æ‹‰å¤§ä¸€ç‚¹æœ‰åŠ©äºå¯¹ç„¦
                    let z = isIOS ? 2.0 : 1.2;
                    z = Math.min(slider.max, z);
                    slider.value = z; slider.disabled = false;
                    applyZoom(z);
                } else { slider.disabled = true; }
                
                document.getElementById('torch-btn').disabled = !trackCapabilities.torch;
                isRunning = true; updateUIState(true);

            } catch (err) {
                log("å¯åŠ¨å¤±è´¥: " + err);
                alert("å¯åŠ¨å¤±è´¥: " + err.message);
                stopPipeline();
            }
        }

        async function stopPipeline() {
            stopRecording(true);
            try { await html5QrCode.stop(); } catch(e){}
            isRunning = false; updateUIState(false);
        }

        async function applyZoom(val) { if(videoTrack&&trackCapabilities.zoom) try{await videoTrack.applyConstraints({advanced:[{zoom:parseFloat(val)}]});}catch(e){} }
        let torchOn = false;
        async function toggleTorch() { if(videoTrack&&trackCapabilities.torch) { torchOn=!torchOn; try{await videoTrack.applyConstraints({advanced:[{torch:torchOn}]});document.getElementById('torch-btn').classList.toggle('bg-yellow-500',torchOn);}catch(e){} } }

        async function handleBarcode(code) {
            log(`Scan: ${code}`);
            const now = Date.now();
            if (code === currentCode && (now - lastCodeTime < DUPLICATE_INTERVAL_MS)) return;
            if (code !== currentCode) {
                if (await checkDuplicate(code)) {
                    if (now - lastCodeTime < DUPLICATE_INTERVAL_MS) return;
                    errorBeep(); showToast(`âš ï¸ é‡å¤: ${code}`, true); lastCodeTime = now; return;
                }
            }
            lastCodeTime = now; triggerSlice(code);
        }

        function triggerSlice(newCode) {
            beep(1200, 80);
            const el = document.getElementById('current-barcode');
            el.innerText = newCode; 
            el.className = "text-2xl font-mono text-white font-bold tracking-widest scale-110 transition-transform";
            setTimeout(()=> el.className = "text-xl font-mono text-green-400 font-bold tracking-wider", 200);
            if (isRecording) stopRecording();
            currentCode = newCode; startRecording();
        }

        function startRecording() {
            if (!stream) return;
            recordedChunks = [];
            let options = { mimeType: 'video/mp4', videoBitsPerSecond: 25000000 }; 
            if (!MediaRecorder.isTypeSupported('video/mp4')) options = { mimeType: 'video/webm', videoBitsPerSecond: 25000000 };
            try { mediaRecorder = new MediaRecorder(stream, options); } catch (e) { mediaRecorder = new MediaRecorder(stream); }
            mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recordedChunks.push(e.data); };
            let clipCode = currentCode;
            mediaRecorder.onstop = () => {
                const finalType = recordedChunks[0] ? recordedChunks[0].type : options.mimeType;
                saveVideo(clipCode, new Blob(recordedChunks, { type: finalType }));
            };
            mediaRecorder.start();
            isRecording = true; 
            document.getElementById('rec-badge').classList.remove('hidden'); 
            document.getElementById('scan-line-el').classList.remove('hidden');
        }

        function stopRecording(force = false) {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') mediaRecorder.stop();
            isRecording = false; 
            document.getElementById('rec-badge').classList.add('hidden'); 
            document.getElementById('scan-line-el').classList.add('hidden');
            if(force) document.getElementById('current-barcode').innerText = "PAUSED";
        }

        function manualTriggerDialog() { const c = prompt("è¾“å…¥å•å·:"); if(c&&c.trim()) handleBarcode(c.trim()); }

        function updateUIState(running) {
            const btn = document.getElementById('main-btn');
            if (running) { 
                btn.innerText = "â¹ åœæ­¢"; 
                btn.className = "w-full bg-red-600 text-white py-4 rounded-xl font-bold text-xl shadow-lg animate-pulse"; 
            } else { 
                btn.innerText = "ğŸ“¸ å¯åŠ¨æ‰«æ"; 
                btn.className = "w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-xl shadow-lg"; 
            }
        }

        function showToast(msg, isErr) {
            const t = document.getElementById('toast'), txt = document.getElementById('toast-text');
            txt.innerText = msg; 
            txt.className = isErr ? "bg-yellow-500 text-black px-6 py-4 rounded-xl text-xl font-bold shadow-2xl border-4 border-yellow-600 block" : "bg-green-600/90 text-white px-6 py-4 rounded-xl text-xl font-bold shadow-2xl backdrop-blur block";
            t.classList.remove('opacity-0'); setTimeout(() => t.classList.add('opacity-0'), 1500);
        }

        async function updateStorageInfo() { try { const { usage } = await navigator.storage.estimate(); document.getElementById('storage-info').innerText = `å·²ç”¨: ${(usage/1024/1024).toFixed(0)} MB`; } catch(e){} }
        function showHistory() { document.getElementById('history-modal').classList.remove('hidden'); doSearch(); }
        function closeHistory() { document.getElementById('history-modal').classList.add('hidden'); }
        function openPlayer(blob, title) {
            const url = URL.createObjectURL(blob), v = document.getElementById('main-player'); v.src = url; v.play(); document.getElementById('player-title').innerText = title;
            const d = document.getElementById('download-btn'); d.href = url; d.download = `${title}.mp4`; document.getElementById('player-modal').classList.remove('hidden');
        }
        function closePlayer() { document.getElementById('main-player').pause(); document.getElementById('player-modal').classList.add('hidden'); }
        function doSearch() {
            const q = document.getElementById('search-input').value.trim(), list = document.getElementById('video-list'); list.innerHTML = ''; let lim = 50;
            db.transaction(['videos'], 'readonly').objectStore('videos').openCursor(null, 'prev').onsuccess = e => {
                const c = e.target.result; if(c && lim > 0) {
                    if(!q || c.value.barcode.includes(q)) {
                        const i = c.value, d = new Date(i.created), ds = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes().toString().padStart(2,'0')}`;
                        const div = document.createElement('div'); div.className = "bg-gray-800 p-3 rounded-lg border-l-4 border-blue-500 mb-2 flex justify-between items-center cursor-pointer active:bg-gray-700";
                        div.onclick = () => openPlayer(i.blob, i.barcode); div.innerHTML = `<div><div class="font-bold text-lg font-mono">${i.barcode}</div><div class="text-xs text-gray-500">${ds} Â· ${(i.size/1024/1024).toFixed(1)}MB</div></div><div class="text-2xl text-blue-500">â–¶</div>`;
                        list.appendChild(div); lim--;
                    } c.continue();
                }
            };
        }
        function clearOldData() { if(!confirm("åˆ é™¤30å¤©å‰çš„æ•°æ®ï¼Ÿ")) return; const m = Date.now()-(30*24*60*60*1000), tx=db.transaction(['videos'],'readwrite'); tx.objectStore('videos').index('created').getAllKeys(IDBKeyRange.upperBound(m)).onsuccess=e=>{const k=e.target.result;if(!k.length)return alert("æ— æ—§æ•°æ®");k.forEach(key=>tx.objectStore('videos').delete(key));tx.oncomplete=()=>{alert(`æ¸…ç†äº† ${k.length} æ¡`);doSearch();updateStorageInfo();};}; }
        function clearAllData() { if(!confirm("âš ï¸ ç¡®å®šæ¸…ç©ºæ‰€æœ‰ï¼Ÿ")) return; if(db) db.close(); indexedDB.deleteDatabase(DB_NAME).onsuccess=()=>{alert("å·²æ¸…ç©º");location.reload();}; }

        window.onload = () => { initDB(); getCameras(); };
    </script>
</body>
</html>
