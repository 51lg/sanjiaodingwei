<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰åœ†å®šä½ - é«˜å¾·åœ°å›¾ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* æ§åˆ¶é¢æ¿ */
        #controls {
            position: absolute; top: 10px; left: 10px; width: 320px; max-width: calc(100vw - 20px);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000; display: flex; flex-direction: column;
            transition: all 0.3s ease;
        }
        
        /* æ§åˆ¶é¢æ¿å¤´éƒ¨ï¼ˆç”¨äºæ‹–æ‹½å’ŒæŠ˜å ï¼‰ */
        .controls-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; background: #007bff; color: white;
            border-radius: 8px 8px 0 0; cursor: pointer;
            font-weight: bold; font-size: 15px;
        }
        .controls-header.collapsed { border-radius: 8px; }

        /* æ§åˆ¶é¢æ¿å†…å®¹åŒº */
        .controls-content {
            padding: 15px; display: flex; flex-direction: column; gap: 12px;
        }

        .row { display: flex; align-items: center; gap: 8px; }
        label { font-size: 14px; font-weight: bold; color: #333; white-space: nowrap;}
        input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; }
        
        button {
            padding: 9px; border: none; border-radius: 4px; 
            font-size: 14px; font-weight: bold; color: white; cursor: pointer;
            transition: opacity 0.2s; white-space: nowrap;
        }
        button:hover { opacity: 0.8; }
        button:active { transform: scale(0.98); }
        
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; width: 100%; }
        .btn-clear { background: #dc3545; width: 100%; }
        
        .tip { 
            font-size: 12px; color: #666; background: #e9ecef; 
            padding: 8px; border-radius: 4px; line-height: 1.5;
        }
    </style>
</head>
<body>

    <div id="controls">
        <div class="controls-header" onclick="togglePanel()" id="panelHeader">
            <span>âš™ï¸ æ§åˆ¶é¢æ¿</span>
            <span id="toggleIcon">â–¼</span>
        </div>
        <div class="controls-content" id="panelContent">
            
            <!-- æœç´¢æ¨¡å— -->
            <div class="row">
                <input type="text" id="searchInput" placeholder="æœç´¢çœå¸‚åŒºæˆ–åœ°å...">
                <button class="btn-primary" onclick="searchLocation()">æœç´¢</button>
            </div>

            <!-- åŠå¾„è®¾ç½® -->
            <div class="row">
                <label>åŠå¾„ (KM):</label>
                <input type="number" id="radius" value="3" step="0.1" placeholder="ä¾‹å¦‚ 1.5">
            </div>
            
            <!-- å®šä½æŒ‰é’® -->
            <button class="btn-success" onclick="locateMe()">ğŸ“ å®šä½æˆ‘å¹¶ç”»åœ†</button>

            <div class="tip">
                ğŸ‘† <strong>æ“ä½œæŒ‡å—ï¼š</strong><br>
                1. è¾“å…¥æƒ³è¦ç”»çš„åŠå¾„ï¼ˆåƒç±³ï¼‰ã€‚<br>
                2. <strong>ç›´æ¥ç‚¹å‡»åœ°å›¾</strong>æˆ–<strong>æœç´¢ä½ç½®</strong>è¿›è¡Œç”»åœˆã€‚<br>
                3. å³ä¸‹è§’å¯åˆ‡æ¢å«æ˜Ÿåœ°å›¾ã€‚
            </div>

            <button class="btn-clear" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰åœ†åœˆ</button>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- åæ ‡è½¬æ¢ç®—æ³• (WGS84 -> GCJ02) è§£å†³å›½å†…åœ°å›¾åç§» ---
        const PI = 3.1415926535897932384626;
        const a = 6378245.0;
        const ee = 0.00669342162296594323;

        function transformLat(x, y) {
            let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
            ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
            ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
            return ret;
        }

        function transformLng(x, y) {
            let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
            ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
            ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
            return ret;
        }

        function wgs84togcj02(lng, lat) {
            if (lng < 72.004 || lng > 137.8347 || lat < 0.8293 || lat > 55.8271) {
                return [lng, lat]; // ä¸åœ¨å›½å†…ï¼Œä¸è¿›è¡Œè½¬æ¢
            }
            let dlat = transformLat(lng - 105.0, lat - 35.0);
            let dlng = transformLng(lng - 105.0, lat - 35.0);
            let radlat = lat / 180.0 * PI;
            let magic = Math.sin(radlat);
            magic = 1 - ee * magic * magic;
            let sqrtmagic = Math.sqrt(magic);
            dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
            dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);
            return [lng + dlng, lat + dlat];
        }


        // 1. åˆå§‹åŒ–åœ°å›¾
        var map = L.map('map', {
            center: [39.9042, 116.4074], // é»˜è®¤åŒ—äº¬
            zoom: 11,
            zoomControl: false // æ‰‹æœºç«¯æ¨èéšè—é»˜è®¤ç¼©æ”¾æ§ä»¶
        });

        // ç”¨äºä¿å­˜æ‰€æœ‰ç”»å‡ºæ¥çš„åœˆå’Œæ ‡è®°ï¼Œæ–¹ä¾¿ä¸€é”®æ¸…ç©º
        var drawnItems = L.featureGroup().addTo(map);

        // 2. åŠ è½½é«˜å¾·å›¾å±‚
        var gaodeVec = L.tileLayer('https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
            maxZoom: 18, attribution: 'é«˜å¾·åœ°å›¾'
        });
        var gaodeSat = L.tileLayer('https://webst01.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}', {
            maxZoom: 18, attribution: 'é«˜å¾·å«æ˜Ÿ'
        });
        gaodeVec.addTo(map);

        var baseMaps = {
            "é«˜å¾·æ ‡å‡†å›¾": gaodeVec,
            "é«˜å¾·å«æ˜Ÿå›¾": gaodeSat
        };
        L.control.layers(baseMaps, null, {position: 'bottomright'}).addTo(map);


        // --- æ ¸å¿ƒç”»åœ†é€»è¾‘ ---
        function drawCircleAt(latlng) {
            var r = parseFloat(document.getElementById('radius').value);
            if(isNaN(r) || r <= 0) {
                r = 3; // é»˜è®¤3å…¬é‡Œ
                document.getElementById('radius').value = 3;
            }
            
            var radiusInMeters = r * 1000; // åƒç±³è½¬ç±³

            // æ·»åŠ ä¸­å¿ƒç‚¹
            L.circleMarker(latlng, {
                radius: 4, color: '#000', fillColor: '#fff', fillOpacity: 1
            }).addTo(drawnItems);

            // æ·»åŠ çº¢è‰²èŒƒå›´åœˆ
            L.circle(latlng, {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.25,
                radius: radiusInMeters
            }).addTo(drawnItems);
        }

        // 3. é¼ æ ‡/æ‰‹æŒ‡ç‚¹å‡»åœ°å›¾ç”»åœ†
        map.on('click', function(e) {
            drawCircleAt(e.latlng);
        });


        // --- é¢æ¿æœ€å°åŒ–åŠŸèƒ½ ---
        var isPanelOpen = true;
        function togglePanel() {
            var content = document.getElementById('panelContent');
            var header = document.getElementById('panelHeader');
            var icon = document.getElementById('toggleIcon');
            
            isPanelOpen = !isPanelOpen;
            if (isPanelOpen) {
                content.style.display = 'flex';
                icon.innerText = 'â–¼';
                header.classList.remove('collapsed');
            } else {
                content.style.display = 'none';
                icon.innerText = 'â—€';
                header.classList.add('collapsed');
            }
        }


        // --- å®šä½åŠŸèƒ½ ---
        function locateMe() {
            if ("geolocation" in navigator) {
                // ä¿®æ”¹æŒ‰é’®çŠ¶æ€æç¤ºç”¨æˆ·
                const btn = document.querySelector('.btn-success');
                const originalText = btn.innerText;
                btn.innerText = "ğŸ“ æ­£åœ¨å®šä½...";
                
                navigator.geolocation.getCurrentPosition(function(position) {
                    btn.innerText = originalText;
                    var wgsLng = position.coords.longitude;
                    var wgsLat = position.coords.latitude;
                    
                    // WGS84 è½¬æ¢ä¸º é«˜å¾·GCJ02 åæ ‡ç³»
                    var gcjCoords = wgs84togcj02(wgsLng, wgsLat);
                    var latlng = L.latLng(gcjCoords[1], gcjCoords[0]);
                    
                    map.setView(latlng, 13);
                    drawCircleAt(latlng);
                }, function(error) {
                    btn.innerText = originalText;
                    alert("å®šä½å¤±è´¥ï¼Œè¯·ç¡®ä¿å·²æˆäºˆæµè§ˆå™¨ä½ç½®æƒé™ã€‚");
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            } else {
                alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½ã€‚");
            }
        }


        // --- æœç´¢åŠŸèƒ½ ---
        function searchLocation() {
            var kw = document.getElementById('searchInput').value.trim();
            if(!kw) {
                alert("è¯·è¾“å…¥æœç´¢å†…å®¹");
                return;
            }
            
            // ä½¿ç”¨å…è´¹çš„ OpenStreetMap Nominatim æœç´¢ API
            var url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(kw)}&limit=1`;
            
            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerText;
            btn.innerText = "æœç´¢ä¸­...";

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    btn.innerText = originalText;
                    if(data && data.length > 0) {
                        var wgsLat = parseFloat(data[0].lat);
                        var wgsLng = parseFloat(data[0].lon);
                        
                        // è½¬æ¢åæ ‡ç³»
                        var gcjCoords = wgs84togcj02(wgsLng, wgsLat);
                        var latlng = L.latLng(gcjCoords[1], gcjCoords[0]);
                        
                        map.setView(latlng, 13);
                        drawCircleAt(latlng);
                        
                        // æ‰‹æœºç«¯æœç´¢å®Œæ¯•åè‡ªåŠ¨æŠ˜å é¢æ¿ï¼Œæ–¹ä¾¿çœ‹åœ°å›¾
                        if(window.innerWidth < 600 && isPanelOpen) {
                            togglePanel();
                        }
                    } else {
                        alert("æœªæ‰¾åˆ°è¯¥åœ°ç‚¹ï¼Œè¯·å°è¯•è¾“å…¥æ›´è¯¦ç»†çš„åœ°å€ã€‚");
                    }
                })
                .catch(err => {
                    btn.innerText = originalText;
                    alert("æœç´¢è¯·æ±‚å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
                });
        }


        // --- æ¸…ç©ºåŠŸèƒ½ ---
        function clearAll() {
            drawnItems.clearLayers();
        }

    </script>
</body>
</html>
