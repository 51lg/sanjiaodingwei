<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>三圆定位 - 迷你精简版</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; background: #f0f0f0; }
        * { box-sizing: border-box; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* --- PC端默认样式 (保持宽敞) --- */
        #controls {
            position: absolute; top: 10px; left: 10px; width: 340px; max-width: calc(100vw - 20px);
            background: rgba(255, 255, 255, 0.98);
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            z-index: 1000; display: flex; flex-direction: column;
            transition: all 0.3s ease;
        }
        
        .controls-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; background: #007bff; color: white;
            border-radius: 8px 8px 0 0; cursor: pointer;
            font-weight: bold; font-size: 14px;
        }
        .controls-header.collapsed { border-radius: 8px; }

        .controls-content {
            padding: 12px; display: flex; flex-direction: column; gap: 10px;
        }

        .row { display: flex; align-items: center; gap: 8px; width: 100%; }
        
        #controls input { 
            flex: 1; padding: 8px; 
            border: 1px solid #ddd; border-radius: 4px; 
            font-size: 13px; outline: none; transition: border 0.2s;
        }
        #controls input:focus { border-color: #007bff; }
        #controls label { font-size: 13px; font-weight: bold; color: #555; white-space: nowrap;}
        
        button {
            padding: 8px 12px; border: none; border-radius: 4px; 
            font-size: 13px; font-weight: bold; color: white; 
            cursor: pointer; transition: opacity 0.2s; 
            word-wrap: break-word; white-space: normal;
        }
        button:hover { opacity: 0.9; }
        button:active { transform: scale(0.98); }
        
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; width: 100%; }
        .btn-clear { background: #dc3545; width: 100%; }
        
        .tip { 
            font-size: 11px; color: #666; background: #f8f9fa; 
            padding: 8px; border-radius: 4px; line-height: 1.4; border: 1px solid #eee;
        }

        /* 图层面板 */
        .layer-panel { border: 1px solid #eee; border-radius: 4px; display: flex; flex-direction: column; background: #fff; width: 100%; }
        .layer-header { background: #f8f9fa; padding: 6px 10px; font-size: 12px; font-weight: bold; border-bottom: 1px solid #eee; color: #666; }
        .layer-list { list-style: none; margin: 0; padding: 0; max-height: 120px; overflow-y: auto; width: 100%; }
        .layer-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; border-bottom: 1px solid #f0f0f0; font-size: 12px; }
        .layer-name { flex: 1; overflow: hidden; text-overflow: ellipsis; margin-right: 5px; color: #333; }
        
        .icon-btn { 
            cursor: pointer; border: none; background: none; 
            font-size: 13px; padding: 0 4px; 
            color: #999; transition: color 0.2s;
        }
        .icon-btn:hover { color: #333; }
        .icon-btn.delete:hover { color: #dc3545; } 
        .icon-btn.eye:hover { color: #007bff; }

        /* 搜索联想列表 */
        .search-wrapper { position: relative; flex: 1; }
        #searchResults {
            position: absolute; top: 100%; left: 0; width: 100%;
            background: white; border: 1px solid #eee; border-top: none;
            border-radius: 0 0 8px 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); 
            z-index: 2000; max-height: 250px; overflow-y: auto; display: none;
        }
        .suggestion-item {
            display: flex; align-items: center; padding: 8px 10px;
            cursor: pointer; border-bottom: 1px solid #f5f5f5;
        }
        .suggestion-item:last-child { border-bottom: none; }
        .suggestion-icon { color: #ccc; font-size: 12px; margin-right: 8px; width: 16px; text-align: center; }
        .suggestion-info { flex: 1; display: flex; flex-direction: column; overflow: hidden; } /* 改为上下排列适应窄屏 */
        .suggestion-name { font-size: 13px; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .suggestion-district { font-size: 10px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 2px; }

        /* ==========================================================
           【关键修改】手机端强制缩小 (Mini Mode)
           ========================================================== */
        body.mobile-mode #controls {
            width: 240px; /* 强制变窄 */
            max-width: 75vw; /* 最多只占屏幕 75% */
            left: 8px; top: 8px;
        }
        body.mobile-mode .controls-header { padding: 8px 10px; font-size: 13px; }
        body.mobile-mode .controls-content { padding: 8px; gap: 8px; }
        body.mobile-mode .row { gap: 5px; }
        
        body.mobile-mode input { padding: 5px; font-size: 12px; }
        body.mobile-mode button { padding: 5px 8px; font-size: 12px; }
        body.mobile-mode label { font-size: 12px; }
        
        /* 手机端搜索建议更加紧凑 */
        body.mobile-mode .suggestion-item { padding: 6px 8px; }
        body.mobile-mode .suggestion-name { font-size: 12px; }
        body.mobile-mode .suggestion-district { font-size: 10px; }

        /* 地图控件位置调整 */
        .leaflet-top.leaflet-right { margin-top: 50px; }
        body.mobile-mode .leaflet-top.leaflet-right { transform: scale(0.8); transform-origin: top right; margin-top: 40px; }
    </style>
</head>
<body>

    <div id="controls">
        <div class="controls-header" onclick="togglePanel()" id="panelHeader">
            <span><i class="fa-solid fa-gear"></i> 控制面板</span>
            <span id="toggleIcon"><i class="fa-solid fa-chevron-down"></i></span>
        </div>
        <div class="controls-content" id="panelContent">
            
            <div class="row">
                <div class="search-wrapper">
                    <input type="text" id="searchInput" placeholder="搜地点..." autocomplete="off">
                    <div id="searchResults"></div>
                </div>
                <button class="btn-primary" onclick="searchLocation()" style="width: 40px; flex-shrink: 0; padding: 5px;" title="搜索"><i class="fa-solid fa-magnifying-glass"></i></button>
            </div>

            <div class="row">
                <label>半径(KM):</label>
                <input type="number" id="radius" value="3" step="0.1" placeholder="3.0">
            </div>
            
            <button id="locateBtn" class="btn-success" onclick="locateMe()"><i class="fa-solid fa-location-crosshairs"></i> 定位我</button>

            <div id="locationConfirmArea" style="display: none; flex-direction: column; gap: 5px; background: #f1f3f5; padding: 6px; border-radius: 4px;">
                <div style="font-size: 11px; color: #333; text-align: center;">在此画圆？</div>
                <div style="display: flex; gap: 5px;">
                    <button class="btn-success" onclick="confirmLocation()" style="flex: 1;"><i class="fa-solid fa-check"></i> 是</button>
                    <button class="btn-clear" onclick="cancelLocation()" style="flex: 1; background: #6c757d;"><i class="fa-solid fa-xmark"></i> 否</button>
                </div>
            </div>

            <button id="clickDrawBtn" class="btn-primary" onclick="toggleClickDraw()" style="background-color: #17a2b8;"><i class="fa-solid fa-hand-pointer"></i> 手点画圆: [开]</button>

            <div class="layer-panel">
                <div class="layer-header"><i class="fa-solid fa-layer-group"></i> 图层列表</div>
                <ul id="layerList" class="layer-list">
                    <li style="padding: 10px; font-size: 11px; color: #bbb; text-align: center;">空</li>
                </ul>
            </div>

            <div class="tip">
                1. 搜索/点击/定位皆可画圆<br>
                2. 右上角切换卫星图
            </div>

            <button class="btn-clear" onclick="clearAll()"><i class="fa-solid fa-trash-can"></i> 清空</button>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const AMAP_KEY = '38a75ef5ceb95f6097fb29b35e8fcb01'; 

        function checkDevice() {
            var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 600;
            if (isMobile) document.body.classList.add('mobile-mode');
            else document.body.classList.remove('mobile-mode');
        }
        checkDevice();
        window.addEventListener('resize', checkDevice);

        const PI = 3.1415926535897932384626;
        const a = 6378245.0;
        const ee = 0.00669342162296594323;

        function transformLat(x, y) {
            let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
            ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
            ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
            return ret;
        }
        function transformLng(x, y) {
            let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
            ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
            ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
            return ret;
        }
        function wgs84togcj02(lng, lat) {
            if (lng < 72.004 || lng > 137.8347 || lat < 0.8293 || lat > 55.8271) return [lng, lat];
            let dlat = transformLat(lng - 105.0, lat - 35.0);
            let dlng = transformLng(lng - 105.0, lat - 35.0);
            let radlat = lat / 180.0 * PI;
            let magic = Math.sin(radlat);
            magic = 1 - ee * magic * magic;
            let sqrtmagic = Math.sqrt(magic);
            dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
            dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);
            return [lng + dlng, lat + dlat];
        }
        function gcj02towgs84(lng, lat) {
            if (lng < 72.004 || lng > 137.8347 || lat < 0.8293 || lat > 55.8271) return [lng, lat];
            let dlat = transformLat(lng - 105.0, lat - 35.0);
            let dlng = transformLng(lng - 105.0, lat - 35.0);
            let radlat = lat / 180.0 * PI;
            let magic = Math.sin(radlat);
            magic = 1 - ee * magic * magic;
            let sqrtmagic = Math.sqrt(magic);
            dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
            dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);
            let mglat = lat + dlat;
            let mglng = lng + dlng;
            return [lng * 2 - mglng, lat * 2 - mglat];
        }

        var map = L.map('map', { center: [39.9042, 116.4074], zoom: 11, zoomControl: false });
        var layersData = {};
        var layerCount = 0;
        var isClickDrawEnabled = true;
        var tempLocateMarker = null;
        var currentCoordSystem = 'GCJ02'; 
        var tempLocateWgsLng = null;
        var tempLocateWgsLat = null;

        var gaodeVec = L.tileLayer('https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', { maxZoom: 18, attribution: '高德地图' });
        var gaodeSat = L.tileLayer('https://webst01.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}', { maxZoom: 18, attribution: '高德卫星' });
        var googleSat = L.tileLayer('https://mt{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', { maxZoom: 18, subdomains: ['0', '1', '2', '3'], attribution: '© Google Maps' });

        gaodeVec.addTo(map);
        L.control.layers({ "高德标准图": gaodeVec, "高德卫星图": gaodeSat, "谷歌纯卫星图": googleSat }, null, {position: 'topright'}).addTo(map);

        map.on('baselayerchange', function (e) {
            var newCoordSystem = (e.name === '谷歌纯卫星图') ? 'WGS84' : 'GCJ02';
            if (newCoordSystem !== currentCoordSystem) {
                var center = map.getCenter();
                var newCenter;
                if (newCoordSystem === 'WGS84') {
                    var wgs = gcj02towgs84(center.lng, center.lat);
                    newCenter = L.latLng(wgs[1], wgs[0]);
                } else {
                    var gcj = wgs84togcj02(center.lng, center.lat);
                    newCenter = L.latLng(gcj[1], gcj[0]);
                }
                map.setView(newCenter, map.getZoom(), { animate: false });
                currentCoordSystem = newCoordSystem;
                
                if (tempLocateMarker && tempLocateWgsLng) {
                    var tLatLng;
                    if (currentCoordSystem === 'GCJ02') {
                        var tGcj = wgs84togcj02(tempLocateWgsLng, tempLocateWgsLat);
                        tLatLng = L.latLng(tGcj[1], tGcj[0]);
                    } else {
                        tLatLng = L.latLng(tempLocateWgsLat, tempLocateWgsLng);
                    }
                    tempLocateMarker.setLatLng(tLatLng);
                }
                
                Object.keys(layersData).forEach(function(id) {
                    var data = layersData[id];
                    var renderLatlng;
                    if (currentCoordSystem === 'GCJ02') {
                        var gcjCoords = wgs84togcj02(data.wgsLng, data.wgsLat);
                        renderLatlng = L.latLng(gcjCoords[1], gcjCoords[0]);
                    } else {
                        renderLatlng = L.latLng(data.wgsLat, data.wgsLng);
                    }
                    data.group.eachLayer(function(layer) { layer.setLatLng(renderLatlng); });
                });
            }
        });

        function debounce(func, wait) {
            let timeout;
            return function () {
                const context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), wait);
            };
        }

        const searchInput = document.getElementById('searchInput');
        const resultsBox = document.getElementById('searchResults');

        function flyToAmapsLoc(lng, lat, name) {
            const wgs = gcj02towgs84(lng, lat);
            const wgsLng = wgs[0];
            const wgsLat = wgs[1];

            let renderLatlng;
            if (currentCoordSystem === 'GCJ02') {
                renderLatlng = L.latLng(lat, lng);
            } else {
                renderLatlng = L.latLng(wgsLat, wgsLng);
            }

            map.setView(renderLatlng, 14);
            createCircleLayer(wgsLng, wgsLat, name);
            if(document.body.classList.contains('mobile-mode') && isPanelOpen) { togglePanel(); }
        }

        searchInput.addEventListener('input', debounce(function() {
            const query = this.value.trim();
            if (query.length < 1) { resultsBox.style.display = 'none'; return; }
            
            const url = `https://restapi.amap.com/v3/assistant/inputtips?key=${AMAP_KEY}&keywords=${encodeURIComponent(query)}&datatype=all`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    if(data.status === '1' && data.tips) {
                        renderSuggestions(data.tips);
                    }
                })
                .catch(err => console.error(err));
        }, 200)); 

        function renderSuggestions(tips) {
            resultsBox.innerHTML = '';
            const validTips = tips.filter(t => t.location && t.location.length > 0);
            
            if (validTips.length === 0) {
                resultsBox.style.display = 'none';
                return;
            }

            validTips.forEach(item => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                
                let districtInfo = "";
                if (item.district && typeof item.district === 'string') {
                    districtInfo = item.district;
                }

                div.innerHTML = `
                    <div class="suggestion-icon"><i class="fa-solid fa-magnifying-glass"></i></div>
                    <div class="suggestion-info">
                        <span class="suggestion-name">${item.name}</span>
                        <span class="suggestion-district">${districtInfo}</span>
                    </div>
                `;

                div.onclick = function() {
                    searchInput.value = item.name;
                    resultsBox.style.display = 'none';
                    const coords = item.location.split(',');
                    flyToAmapsLoc(parseFloat(coords[0]), parseFloat(coords[1]), item.name);
                };
                resultsBox.appendChild(div);
            });
            resultsBox.style.display = 'block';
        }

        function searchLocation() {
            var kw = document.getElementById('searchInput').value.trim();
            if(!kw) { alert("请输入地点"); return; }
            
            const btn = document.querySelector('.btn-primary');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';

            const url = `https://restapi.amap.com/v3/place/text?key=${AMAP_KEY}&keywords=${encodeURIComponent(kw)}&offset=1&page=1&extensions=base`;

            fetch(url).then(r => r.json()).then(data => {
                btn.innerHTML = originalHTML;
                if(data.status === '1' && data.pois && data.pois.length > 0) {
                    const poi = data.pois[0];
                    const coords = poi.location.split(',');
                    flyToAmapsLoc(parseFloat(coords[0]), parseFloat(coords[1]), poi.name);
                } else {
                    alert("未找到该地点");
                }
            }).catch(e => { btn.innerHTML = originalHTML; alert("请求失败"); });
        }

        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
                resultsBox.style.display = 'none';
            }
        });

        function updateLayerUI() {
            var list = document.getElementById('layerList');
            list.innerHTML = '';
            var keys = Object.keys(layersData).reverse();
            if (keys.length === 0) {
                list.innerHTML = '<li style="padding: 10px; font-size: 11px; color: #bbb; text-align: center;">空</li>';
                return;
            }
            keys.forEach(function(id) {
                var data = layersData[id];
                var li = document.createElement('li');
                li.className = 'layer-item';
                
                var nameSpan = document.createElement('span');
                nameSpan.className = 'layer-name';
                nameSpan.innerText = data.name;
                nameSpan.title = data.name;
                if(!data.visible) { nameSpan.style.color = '#ccc'; nameSpan.style.textDecoration = 'line-through'; }
                
                var actions = document.createElement('div');
                var eyeBtn = document.createElement('button');
                eyeBtn.className = 'icon-btn eye'; 
                eyeBtn.innerHTML = data.visible ? '<i class="fa-solid fa-eye"></i>' : '<i class="fa-solid fa-eye-slash"></i>';
                eyeBtn.onclick = function() { toggleLayerVisibility(id); };
                var delBtn = document.createElement('button');
                delBtn.className = 'icon-btn delete';
                delBtn.innerHTML = '<i class="fa-solid fa-trash-can"></i>';
                delBtn.onclick = function() { deleteLayer(id); };
                
                actions.appendChild(eyeBtn); actions.appendChild(delBtn);
                li.appendChild(nameSpan); li.appendChild(actions);
                list.appendChild(li);
            });
        }

        function toggleLayerVisibility(id) {
            var data = layersData[id];
            if(data.visible) { map.removeLayer(data.group); data.visible = false; }
            else { map.addLayer(data.group); data.visible = true; }
            updateLayerUI();
        }
        function deleteLayer(id) {
            map.removeLayer(layersData[id].group);
            delete layersData[id];
            updateLayerUI();
        }

        function createCircleLayer(wgsLng, wgsLat, sourceName) {
            var r = parseFloat(document.getElementById('radius').value);
            if(isNaN(r) || r <= 0) { r = 3; document.getElementById('radius').value = 3; }
            
            var renderLatlng;
            if (currentCoordSystem === 'GCJ02') {
                var gcj = wgs84togcj02(wgsLng, wgsLat);
                renderLatlng = L.latLng(gcj[1], gcj[0]);
            } else {
                renderLatlng = L.latLng(wgsLat, wgsLng);
            }
            
            var marker = L.circleMarker(renderLatlng, { radius: 5, color: '#007bff', fillColor: '#fff', fillOpacity: 1 });
            var circle = L.circle(renderLatlng, { color: '#dc3545', fillColor: '#f03', fillOpacity: 0.15, weight: 2, radius: r * 1000 });
            var layerGroup = L.layerGroup([marker, circle]).addTo(map);
            
            layerCount++;
            var layerId = 'layer_' + Date.now();
            layersData[layerId] = { group: layerGroup, visible: true, name: `L${layerCount}: ${sourceName}`, wgsLng: wgsLng, wgsLat: wgsLat };
            updateLayerUI();
        }

        function toggleClickDraw() {
            isClickDrawEnabled = !isClickDrawEnabled;
            var btn = document.getElementById('clickDrawBtn');
            if (isClickDrawEnabled) {
                btn.style.backgroundColor = '#17a2b8';
                btn.innerHTML = '<i class="fa-solid fa-hand-pointer"></i> 手点画圆: [开]';
            } else {
                btn.style.backgroundColor = '#6c757d';
                btn.innerHTML = '<i class="fa-solid fa-hand-pointer"></i> 手点画圆: [关]';
            }
        }
        map.on('click', function(e) {
            if (isClickDrawEnabled) {
                var wgsLng, wgsLat;
                if (currentCoordSystem === 'GCJ02') {
                    var wgs = gcj02towgs84(e.latlng.lng, e.latlng.lat);
                    wgsLng = wgs[0]; wgsLat = wgs[1];
                } else {
                    wgsLng = e.latlng.lng; wgsLat = e.latlng.lat;
                }
                createCircleLayer(wgsLng, wgsLat, "手点地图");
            }
        });

        var isPanelOpen = true;
        function togglePanel() {
            var content = document.getElementById('panelContent');
            var header = document.getElementById('panelHeader');
            var icon = document.getElementById('toggleIcon');
            isPanelOpen = !isPanelOpen;
            if (isPanelOpen) {
                content.style.display = 'flex'; icon.innerHTML = '<i class="fa-solid fa-chevron-down"></i>'; header.classList.remove('collapsed');
            } else {
                content.style.display = 'none'; icon.innerHTML = '<i class="fa-solid fa-chevron-left"></i>'; header.classList.add('collapsed');
            }
        }

        function locateMe() {
            if ("geolocation" in navigator) {
                const btn = document.getElementById('locateBtn');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> 定位中...';
                navigator.geolocation.getCurrentPosition(function(position) {
                    btn.innerHTML = originalHTML;
                    var wgsLng = position.coords.longitude;
                    var wgsLat = position.coords.latitude;
                    
                    var renderLatlng;
                    if (currentCoordSystem === 'GCJ02') {
                        var gcj = wgs84togcj02(wgsLng, wgsLat);
                        renderLatlng = L.latLng(gcj[1], gcj[0]);
                    } else {
                        renderLatlng = L.latLng(wgsLat, wgsLng);
                    }
                    
                    map.setView(renderLatlng, 17);
                    if(tempLocateMarker) map.removeLayer(tempLocateMarker);
                    tempLocateMarker = L.marker(renderLatlng).addTo(map);
                    tempLocateWgsLng = wgsLng;
                    tempLocateWgsLat = wgsLat;
                    
                    btn.style.display = 'none';
                    document.getElementById('locationConfirmArea').style.display = 'flex';
                    if(!isPanelOpen) togglePanel();
                    
                }, function(error) { btn.innerHTML = originalHTML; alert("定位失败或拒绝权限"); }, { enableHighAccuracy: true });
            } else { alert("浏览器不支持定位"); }
        }
        function confirmLocation() {
            if(tempLocateWgsLng) createCircleLayer(tempLocateWgsLng, tempLocateWgsLat, "我的位置");
            resetLocateUI();
        }
        function cancelLocation() { resetLocateUI(); }
        function resetLocateUI() {
            if(tempLocateMarker) { map.removeLayer(tempLocateMarker); tempLocateMarker = null; }
            document.getElementById('locateBtn').style.display = 'block';
            document.getElementById('locationConfirmArea').style.display = 'none';
        }
        function clearAll() {
            Object.keys(layersData).forEach(function(id) { map.removeLayer(layersData[id].group); });
            layersData = {}; layerCount = 0; updateLayerUI();
        }
    </script>
</body>
</html>
