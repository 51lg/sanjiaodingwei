<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸‰åœ†å®šä½ - é«˜å¾·åœ°å›¾ç‰ˆ</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: "Microsoft YaHei", sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* æ§åˆ¶é¢æ¿ */
        #controls {
            position: absolute; top: 10px; left: 10px; width: 320px; max-width: calc(100vw - 20px);
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000; display: flex; flex-direction: column;
            transition: all 0.3s ease;
        }
        
        /* æ§åˆ¶é¢æ¿å¤´éƒ¨ï¼ˆç”¨äºæ‹–æ‹½å’ŒæŠ˜å ï¼‰ */
        .controls-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 15px; background: #007bff; color: white;
            border-radius: 8px 8px 0 0; cursor: pointer;
            font-weight: bold; font-size: 15px;
        }
        .controls-header.collapsed { border-radius: 8px; }

        /* æ§åˆ¶é¢æ¿å†…å®¹åŒº */
        .controls-content {
            padding: 15px; display: flex; flex-direction: column; gap: 12px;
        }

        .row { display: flex; align-items: center; gap: 8px; }
        label { font-size: 14px; font-weight: bold; color: #333; white-space: nowrap;}
        input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; width: 100%; box-sizing: border-box; }
        
        button {
            padding: 9px; border: none; border-radius: 4px; 
            font-size: 14px; font-weight: bold; color: white; cursor: pointer;
            transition: opacity 0.2s; white-space: nowrap;
        }
        button:hover { opacity: 0.8; }
        button:active { transform: scale(0.98); }
        
        .btn-primary { background: #007bff; }
        .btn-success { background: #28a745; width: 100%; }
        .btn-clear { background: #dc3545; width: 100%; }
        
        .tip { 
            font-size: 12px; color: #666; background: #e9ecef; 
            padding: 8px; border-radius: 4px; line-height: 1.5;
        }

        /* PSé£æ ¼å›¾å±‚é¢æ¿ */
        .layer-panel { border: 1px solid #ddd; border-radius: 4px; display: flex; flex-direction: column; background: #fff; }
        .layer-header { background: #f1f3f5; padding: 6px 10px; font-size: 12px; font-weight: bold; border-bottom: 1px solid #ddd; color: #495057; }
        .layer-list { list-style: none; margin: 0; padding: 0; max-height: 140px; overflow-y: auto; }
        .layer-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 10px; border-bottom: 1px solid #eee; font-size: 13px; transition: background 0.2s; }
        .layer-item:hover { background: #f8f9fa; }
        .layer-item:last-child { border-bottom: none; }
        .layer-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-right: 10px; }
        .layer-actions { display: flex; gap: 8px; }
        .icon-btn { cursor: pointer; border: none; background: none; font-size: 14px; padding: 0; opacity: 0.7; transition: opacity 0.2s; }
        .icon-btn:hover { opacity: 1; }
    </style>
</head>
<body>

    <div id="controls">
        <div class="controls-header" onclick="togglePanel()" id="panelHeader">
            <span>âš™ï¸ æ§åˆ¶é¢æ¿</span>
            <span id="toggleIcon">â–¼</span>
        </div>
        <div class="controls-content" id="panelContent">
            
            <!-- æœç´¢æ¨¡å— -->
            <div class="row">
                <input type="text" id="searchInput" placeholder="æœç´¢çœå¸‚åŒºæˆ–åœ°å...">
                <button class="btn-primary" onclick="searchLocation()">æœç´¢</button>
            </div>

            <!-- åŠå¾„è®¾ç½® -->
            <div class="row">
                <label>åŠå¾„ (KM):</label>
                <input type="number" id="radius" value="3" step="0.1" placeholder="ä¾‹å¦‚ 1.5">
            </div>
            
            <!-- å®šä½æŒ‰é’® -->
            <button class="btn-success" onclick="locateMe()">ğŸ“ å®šä½æˆ‘å¹¶ç”»åœ†</button>

            <!-- ç‚¹å‡»ç”»åœ†å¼€å…³ -->
            <button id="clickDrawBtn" class="btn-primary" onclick="toggleClickDraw()" style="background-color: #17a2b8;">ğŸ‘† å…è®¸æ‰‹ç‚¹åœ°å›¾ç”»åœ†: [å¼€å¯]</button>

            <!-- PSé£æ ¼å›¾å±‚é¢æ¿ -->
            <div class="layer-panel">
                <div class="layer-header">ğŸ“š å›¾å±‚é¢æ¿ (ç±»ä¼¼PS)</div>
                <ul id="layerList" class="layer-list">
                    <!-- åŠ¨æ€ç”Ÿæˆå›¾å±‚ -->
                    <li style="padding: 10px; font-size: 12px; color: #999; text-align: center;">æš‚æ— å›¾å±‚ï¼Œè¯·ç”»åœ†</li>
                </ul>
            </div>

            <div class="tip">
                ğŸ‘† <strong>æ“ä½œæŒ‡å—ï¼š</strong><br>
                1. è¾“å…¥æƒ³è¦ç”»çš„åŠå¾„ï¼ˆåƒç±³ï¼‰ã€‚<br>
                2. <strong>ç›´æ¥ç‚¹å‡»åœ°å›¾</strong>æˆ–<strong>æœç´¢ä½ç½®</strong>è¿›è¡Œç”»åœˆã€‚<br>
                3. å³ä¸‹è§’å¯åˆ‡æ¢å«æ˜Ÿåœ°å›¾ã€‚
            </div>

            <button class="btn-clear" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰åœ†åœˆ</button>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- åæ ‡è½¬æ¢ç®—æ³• (WGS84 -> GCJ02) è§£å†³å›½å†…åœ°å›¾åç§» ---
        const PI = 3.1415926535897932384626;
        const a = 6378245.0;
        const ee = 0.00669342162296594323;

        function transformLat(x, y) {
            let ret = -100.0 + 2.0 * x + 3.0 * y + 0.2 * y * y + 0.1 * x * y + 0.2 * Math.sqrt(Math.abs(x));
            ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(y * PI) + 40.0 * Math.sin(y / 3.0 * PI)) * 2.0 / 3.0;
            ret += (160.0 * Math.sin(y / 12.0 * PI) + 320 * Math.sin(y * PI / 30.0)) * 2.0 / 3.0;
            return ret;
        }

        function transformLng(x, y) {
            let ret = 300.0 + x + 2.0 * y + 0.1 * x * x + 0.1 * x * y + 0.1 * Math.sqrt(Math.abs(x));
            ret += (20.0 * Math.sin(6.0 * x * PI) + 20.0 * Math.sin(2.0 * x * PI)) * 2.0 / 3.0;
            ret += (20.0 * Math.sin(x * PI) + 40.0 * Math.sin(x / 3.0 * PI)) * 2.0 / 3.0;
            ret += (150.0 * Math.sin(x / 12.0 * PI) + 300.0 * Math.sin(x / 30.0 * PI)) * 2.0 / 3.0;
            return ret;
        }

        function wgs84togcj02(lng, lat) {
            if (lng < 72.004 || lng > 137.8347 || lat < 0.8293 || lat > 55.8271) {
                return [lng, lat]; // ä¸åœ¨å›½å†…ï¼Œä¸è¿›è¡Œè½¬æ¢
            }
            let dlat = transformLat(lng - 105.0, lat - 35.0);
            let dlng = transformLng(lng - 105.0, lat - 35.0);
            let radlat = lat / 180.0 * PI;
            let magic = Math.sin(radlat);
            magic = 1 - ee * magic * magic;
            let sqrtmagic = Math.sqrt(magic);
            dlat = (dlat * 180.0) / ((a * (1 - ee)) / (magic * sqrtmagic) * PI);
            dlng = (dlng * 180.0) / (a / sqrtmagic * Math.cos(radlat) * PI);
            return [lng + dlng, lat + dlat];
        }


        // 1. åˆå§‹åŒ–åœ°å›¾
        var map = L.map('map', {
            center: [39.9042, 116.4074], // é»˜è®¤åŒ—äº¬
            zoom: 11,
            zoomControl: false // æ‰‹æœºç«¯æ¨èéšè—é»˜è®¤ç¼©æ”¾æ§ä»¶
        });

        // å›¾å±‚ç®¡ç†çŠ¶æ€ (ç±»ä¼¼PS)
        var layersData = {};
        var layerCount = 0;
        var isClickDrawEnabled = true;

        // 2. åŠ è½½é«˜å¾·å›¾å±‚
        var gaodeVec = L.tileLayer('https://webrd01.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}', {
            maxZoom: 18, attribution: 'é«˜å¾·åœ°å›¾'
        });
        var gaodeSat = L.tileLayer('https://webst01.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}', {
            maxZoom: 18, attribution: 'é«˜å¾·å«æ˜Ÿ'
        });
        
        // æ–°å¢ï¼šè°·æ­Œå«æ˜Ÿæ··åˆå›¾å±‚ (lyrs=y è¡¨ç¤ºå«æ˜Ÿå›¾+åœ°å/é“è·¯æ ‡ç­¾)
        var googleSat = L.tileLayer('https://mt{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
            maxZoom: 18,
            subdomains: ['0', '1', '2', '3'],
            attribution: 'Â© Google Maps'
        });

        gaodeVec.addTo(map);

        var baseMaps = {
            "é«˜å¾·æ ‡å‡†å›¾": gaodeVec,
            "é«˜å¾·å«æ˜Ÿå›¾": gaodeSat,
            "è°·æ­Œå«æ˜Ÿå›¾": googleSat
        };
        L.control.layers(baseMaps, null, {position: 'bottomright'}).addTo(map);


        // --- å›¾å±‚é¢æ¿ UI æ›´æ–°é€»è¾‘ ---
        function updateLayerUI() {
            var list = document.getElementById('layerList');
            list.innerHTML = '';
            var keys = Object.keys(layersData).reverse(); // æ–°å›¾å±‚åœ¨æœ€ä¸Šé¢
            
            if (keys.length === 0) {
                list.innerHTML = '<li style="padding: 10px; font-size: 12px; color: #999; text-align: center;">æš‚æ— å›¾å±‚ï¼Œè¯·ç”»åœ†</li>';
                return;
            }

            keys.forEach(function(id) {
                var data = layersData[id];
                var li = document.createElement('li');
                li.className = 'layer-item';
                
                var nameSpan = document.createElement('span');
                nameSpan.className = 'layer-name';
                nameSpan.innerText = data.name;
                if(!data.visible) {
                    nameSpan.style.color = '#adb5bd';
                    nameSpan.style.textDecoration = 'line-through';
                }
                
                var actions = document.createElement('div');
                actions.className = 'layer-actions';
                
                var eyeBtn = document.createElement('button');
                eyeBtn.className = 'icon-btn';
                eyeBtn.innerHTML = data.visible ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
                eyeBtn.title = "æ˜¾ç¤º/éšè—å›¾å±‚";
                eyeBtn.onclick = function() { toggleLayerVisibility(id); };
                
                var delBtn = document.createElement('button');
                delBtn.className = 'icon-btn';
                delBtn.innerHTML = 'ğŸ—‘ï¸';
                delBtn.title = "åˆ é™¤æ­¤å›¾å±‚";
                delBtn.onclick = function() { deleteLayer(id); };
                
                actions.appendChild(eyeBtn);
                actions.appendChild(delBtn);
                li.appendChild(nameSpan);
                li.appendChild(actions);
                list.appendChild(li);
            });
        }

        function toggleLayerVisibility(id) {
            var data = layersData[id];
            if(data.visible) {
                map.removeLayer(data.group);
                data.visible = false;
            } else {
                map.addLayer(data.group);
                data.visible = true;
            }
            updateLayerUI();
        }

        function deleteLayer(id) {
            var data = layersData[id];
            map.removeLayer(data.group);
            delete layersData[id];
            updateLayerUI();
        }

        // --- æ ¸å¿ƒç”»åœ†é€»è¾‘ ---
        function drawCircleAt(latlng, sourceName) {
            var r = parseFloat(document.getElementById('radius').value);
            if(isNaN(r) || r <= 0) {
                r = 3; // é»˜è®¤3å…¬é‡Œ
                document.getElementById('radius').value = 3;
            }
            
            var radiusInMeters = r * 1000; // åƒç±³è½¬ç±³

            // æ·»åŠ ä¸­å¿ƒç‚¹å’Œåœ†
            var marker = L.circleMarker(latlng, {
                radius: 4, color: '#000', fillColor: '#fff', fillOpacity: 1
            });
            var circle = L.circle(latlng, {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.25,
                radius: radiusInMeters
            });

            // ç»„åˆæˆä¸€ä¸ªå›¾å±‚ç»„
            var layerGroup = L.layerGroup([marker, circle]).addTo(map);

            // æ³¨å†Œåˆ°å›¾å±‚é¢æ¿
            layerCount++;
            var layerId = 'layer_' + Date.now();
            var finalName = sourceName ? sourceName : "æœªçŸ¥ä½ç½®";
            layersData[layerId] = {
                group: layerGroup,
                visible: true,
                name: `å›¾å±‚${layerCount}: ${finalName} (R:${r}KM)`
            };

            updateLayerUI();
        }

        // 3. æ‰‹ç‚¹åœ°å›¾ç”»åœ†å¼€å…³
        function toggleClickDraw() {
            isClickDrawEnabled = !isClickDrawEnabled;
            var btn = document.getElementById('clickDrawBtn');
            if (isClickDrawEnabled) {
                btn.style.backgroundColor = '#17a2b8';
                btn.innerText = 'ğŸ‘† å…è®¸æ‰‹ç‚¹åœ°å›¾ç”»åœ†: [å¼€å¯]';
            } else {
                btn.style.backgroundColor = '#6c757d';
                btn.innerText = 'ğŸ‘† å…è®¸æ‰‹ç‚¹åœ°å›¾ç”»åœ†: [å…³é—­]';
            }
        }

        map.on('click', function(e) {
            if (isClickDrawEnabled) {
                drawCircleAt(e.latlng, "æ‰‹ç‚¹åœ°å›¾");
            }
        });


        // --- é¢æ¿æœ€å°åŒ–åŠŸèƒ½ ---
        var isPanelOpen = true;
        function togglePanel() {
            var content = document.getElementById('panelContent');
            var header = document.getElementById('panelHeader');
            var icon = document.getElementById('toggleIcon');
            
            isPanelOpen = !isPanelOpen;
            if (isPanelOpen) {
                content.style.display = 'flex';
                icon.innerText = 'â–¼';
                header.classList.remove('collapsed');
            } else {
                content.style.display = 'none';
                icon.innerText = 'â—€';
                header.classList.add('collapsed');
            }
        }


        // --- å®šä½åŠŸèƒ½ ---
        function locateMe() {
            if ("geolocation" in navigator) {
                // ä¿®æ”¹æŒ‰é’®çŠ¶æ€æç¤ºç”¨æˆ·
                const btn = document.querySelector('.btn-success');
                const originalText = btn.innerText;
                btn.innerText = "ğŸ“ æ­£åœ¨å®šä½...";
                
                navigator.geolocation.getCurrentPosition(function(position) {
                    btn.innerText = originalText;
                    var wgsLng = position.coords.longitude;
                    var wgsLat = position.coords.latitude;
                    
                    // WGS84 è½¬æ¢ä¸º é«˜å¾·GCJ02 åæ ‡ç³»
                    var gcjCoords = wgs84togcj02(wgsLng, wgsLat);
                    var latlng = L.latLng(gcjCoords[1], gcjCoords[0]);
                    
                    map.setView(latlng, 13);
                    drawCircleAt(latlng, "æˆ‘çš„ä½ç½®");
                }, function(error) {
                    btn.innerText = originalText;
                    alert("å®šä½å¤±è´¥ï¼Œè¯·ç¡®ä¿å·²æˆäºˆæµè§ˆå™¨ä½ç½®æƒé™ã€‚");
                }, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            } else {
                alert("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½ã€‚");
            }
        }


        // --- æœç´¢åŠŸèƒ½ ---
        function searchLocation() {
            var kw = document.getElementById('searchInput').value.trim();
            if(!kw) {
                alert("è¯·è¾“å…¥æœç´¢å†…å®¹");
                return;
            }
            
            // ä½¿ç”¨å…è´¹çš„ OpenStreetMap Nominatim æœç´¢ API
            var url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(kw)}&limit=1`;
            
            const btn = document.querySelector('.btn-primary');
            const originalText = btn.innerText;
            btn.innerText = "æœç´¢ä¸­...";

            fetch(url)
                .é”®ï¼Œç„¶å(response => response.json())
                .é”®ï¼Œç„¶å(data => {
                    btn.innerText = originalText;
                    if(data && data.length > 0) {
                        var wgsLat = parseFloat(data[0].lat);
                        var wgsLng = parseFloat(data[0].lon);
                        
                        // è½¬æ¢åæ ‡ç³»
                        var gcjCoords = wgs84togcj02(wgsLng, wgsLat);
                        var latlng = L.latLng(gcjCoords[1], gcjCoords[0]);
                        
                        map.setView(latlng, 13);
                        drawCircleAt(latlng, kw);
                        
                        // æ‰‹æœºç«¯æœç´¢å®Œæ¯•åè‡ªåŠ¨æŠ˜å é¢æ¿ï¼Œæ–¹ä¾¿çœ‹åœ°å›¾
                        if(window.innerWidth < 600 && isPanelOpen) {
                            togglePanel();
                        }
                    } else {
                        alert("æœªæ‰¾åˆ°è¯¥åœ°ç‚¹ï¼Œè¯·å°è¯•è¾“å…¥æ›´è¯¦ç»†çš„åœ°å€ã€‚");
                    }
                })
                .catch(err => {
                    btn.innerText = originalText;
                    alert("æœç´¢è¯·æ±‚å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚");
                });
        }


        // --- æ¸…ç©ºåŠŸèƒ½ ---
        function clearAll() {
            Object.keys(layersData).forEach(function(id) {
                map.removeLayer(layersData[id].group);
            });
            layersData = {};
            layerCount = 0;
            updateLayerUI();
        }

    </script>
</body>
</html>
